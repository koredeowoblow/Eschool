import{SidebarManager}from"./core/SidebarManager.js";const App=(()=>{(()=>{const e=document.querySelector('meta[name="csrf-token"]'),t=localStorage.getItem("auth_token");window.axios&&(axios.defaults.withCredentials=!0,axios.defaults.headers.common["X-Requested-With"]="XMLHttpRequest",e&&(axios.defaults.headers.common["X-CSRF-TOKEN"]=e.content),t&&(axios.defaults.headers.common.Authorization=`Bearer ${t}`),axios.interceptors.response.use(e=>(!e.data||!1!==e.data.success||"Unauthenticated"!==e.data.message&&"Unauthenticated."!==e.data.message||(console.warn("App: Explicit Unauthenticated response. Redirecting."),localStorage.clear(),sessionStorage.clear(),window.location.replace("/")),e),e=>(e.response&&([401,419].includes(e.response.status)||e.response.data&&"Unauthenticated."===e.response.data.message)&&(console.warn("Session expired or unauthorized. Clearing storage and redirecting."),localStorage.clear(),sessionStorage.clear(),window.location.replace("/")),Promise.reject(e))))})();let e=null,t=!1;const n={user:null,currentStudentId:null,controllers:{table:null},table:{sortField:null,sortOrder:"asc",lastUrl:null,entityType:null,tbodyId:null}},a=e=>e?String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):"",s=(e,...t)=>e.reduce((e,n,s)=>{let o=void 0!==t[s]&&null!==t[s]?t[s]:"";return"string"==typeof o?o=a(o):o&&"object"==typeof o&&o.__isSafe?o=o.html:null!=o&&(o=a(String(o))),e+n+o},""),o=e=>({html:e,__isSafe:!0}),i=async(t=!1)=>!t&&I.user?I.user:!t&&window.AppConfig?.user?(I.user=window.AppConfig.user,I.user):(e&&!t||(e=axios.get("/api/v1/user").then(e=>{const t=e.data?.data||e.data;if(n.user=t,window.AppConfig&&(window.AppConfig.user=t),t.roles?.includes("guardian")&&t.guardian?.students?.length>0){const e=localStorage.getItem("guardian_selected_student_id"),a=t.guardian.students,s=a.find(t=>String(t.id)===String(e));e&&s?n.currentStudentId=e:(n.currentStudentId=a[0].id,localStorage.setItem("guardian_selected_student_id",a[0].id))}else t.roles?.includes("student")&&(n.currentStudentId=t.student?.id);return t}).catch(e=>(console.warn("App: User context fetch failed",e),null))),e),d=()=>{const e=n.user;if(!e||!e.roles?.includes("guardian"))return;const t=e.guardian?.students||[];if(t.length<=1)return;const s=document.getElementById("guardian-student-selector-container");if(!s)return;const o=I.currentStudentId;let i=`\n            <div class="dropdown">\n                <button class="btn btn-white border shadow-sm dropdown-toggle d-flex align-items-center gap-2" type="button" data-bs-toggle="dropdown">\n                    <i class="bi bi-people text-primary"></i>\n                    <span>Viewing: <strong>${a(t.find(e=>String(e.id)===String(o))?.full_name||"Select Child")}</strong></span>\n                </button>\n                <ul class="dropdown-menu shadow border-0">\n                    <li class="dropdown-header">Switch Child</li>\n        `;t.forEach(e=>{i+=`\n                <li>\n                    <a class="dropdown-item d-flex align-items-center gap-2 ${String(e.id)===String(o)?"active":""}" \n                       href="#" onclick="event.preventDefault(); App.selectStudent(${e.id})">\n                        <i class="bi bi-person"></i>\n                        ${a(e.full_name)}\n                    </a>\n                </li>\n            `}),i+="</ul></div>",s.innerHTML=i},r=()=>{const e=window.AppConfig?.active_session;if(!e||"closed"!==e.status&&"locked"!==e.status)return;if(document.querySelector(".admin-header")&&!document.getElementById("session-lock-banner")){const t=document.createElement("div");t.id="session-lock-banner",t.className="bg-danger text-white text-center py-1 small fw-bold fixed-top",t.style.zIndex="1060",t.textContent=`SESSION LOCKED: ${e.name} is currently closed. Read-only mode active.`,document.body.prepend(t),document.body.style.paddingTop="24px"}document.querySelectorAll('button[data-bs-target*="create"], button[data-bs-target*="edit"], .btn-primary-premium:not([data-bs-dismiss])').forEach(e=>{e.innerText.includes("Search")||e.innerText.includes("Filter")||(e.disabled=!0,e.classList.add("disabled"),e.title="Action disabled: Session is closed.")}),document.querySelectorAll(".requires-session-lock").forEach(e=>{e.disabled=!0,e.classList.add("disabled")}),document.addEventListener("shown.bs.modal",()=>{const e=window.AppConfig?.active_session;if(!e||"closed"!==e.status&&"locked"!==e.status)return;document.querySelectorAll(".modal.show").forEach(e=>{const t=e.querySelector("form");if(t){t.querySelectorAll('input, select, textarea, button[type="submit"]').forEach(e=>{e.disabled=!0});const n=e.querySelector(".modal-footer");if(n&&!n.querySelector(".lock-msg")){const e=document.createElement("small");e.className="text-danger fw-bold me-3 lock-msg",e.textContent="Session Locked - Read Only",n.prepend(e)}}})})},c=async()=>{const e=document.getElementById("dashboard-stats-root");if(e){e.innerHTML='\n            <div class="col-12 text-center py-5">\n                <div class="spinner-border text-primary" role="status"></div>\n                <div class="mt-2 text-muted italic">Gathering insights...</div>\n            </div>\n        ';try{const t=await axios.get("/api/v1/dashboard/stats");if(!t?.data?.data)throw new Error;e.replaceChildren();const n=t.data.data;n.platform?u(e,n.platform):n.student?p(e,n.student):n.teacher?g(e,n.teacher):n.general&&b(e,n),n.charts&&l(n.charts)}catch(t){console.error("Dashboard load error:",t),e.textContent="Failed to load dashboard data."}}},l=e=>{const t=document.getElementById("dashboard-charts-root");t&&(t.replaceChildren(),Object.entries(e).forEach(([e,n],a)=>{const s=document.createElement("div");s.className="col-md-6";const o=document.createElement("div");o.className="card-premium h-100 p-4",o.classList.add("animate-in","stagger-"+(a%3+1));const i=document.createElement("h6");i.className="fw-bold text-dark mb-3 text-uppercase small",i.textContent=e.replace(/_/g," ");const d=document.createElement("div");d.style.position="relative",d.style.height="300px",d.style.width="100%";const r=document.createElement("canvas");d.appendChild(r),o.append(i,d),s.appendChild(o),t.appendChild(s),new Chart(r,m(e,n))}))},m=(e,t)=>{const n="#4f46e5",a="#ec4899",s="#10b981",o="#64748b",i={responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{backgroundColor:"rgba(255, 255, 255, 0.9)",titleColor:"#1e293b",bodyColor:"#475569",borderColor:"#e2e8f0",borderWidth:1,padding:10,displayColors:!1}},scales:{x:{grid:{display:!1},ticks:{color:o}},y:{grid:{color:"#e2e8f0",borderDash:[5,5]},ticks:{color:o}}}};return"school_growth"===e||"class_performance"===e?{type:"bar",data:{labels:t.labels,datasets:[{label:"Count",data:t.data,backgroundColor:n,borderRadius:4,maxBarThickness:40}]},options:i}:"revenue_trends"===e||"transaction_flow"===e||"performance_trend"===e?{type:"line",data:{labels:t.labels,datasets:[{label:"Value",data:t.data,borderColor:a,backgroundColor:e=>{const t=e.chart.ctx.createLinearGradient(0,0,0,300);return t.addColorStop(0,"rgba(236, 72, 153, 0.2)"),t.addColorStop(1,"rgba(236, 72, 153, 0)"),t},fill:!0,tension:.4,borderWidth:2,pointRadius:0,pointHoverRadius:6}]},options:i}:"enrollment_distribution"===e?{type:"doughnut",data:{labels:t.map(e=>e.label),datasets:[{data:t.map(e=>e.value),backgroundColor:[n,a,s,"#f59e0b","#8b5cf6"],borderWidth:0}]},options:{...i,cutout:"75%",plugins:{legend:{position:"right",labels:{usePointStyle:!0,boxWidth:8}}},scales:{x:{display:!1},y:{display:!1}}}}:{}},u=(e,t)=>{[["Total Schools",t.total_schools],["Total Users",t.total_users],["Total Revenue",M(t.total_revenue)]].forEach(([t,n],a)=>{const s=h(t,n);s.classList.add("animate-in","stagger-"+(a%5+1)),e.appendChild(s)})},p=(e,t)=>{[h("Attendance Rate",`${Math.round(t.attendance)}%`,"bi-calendar-check"),h("Active Assignments",t.assignments,"bi-journal-text"),h("Average Grade",t.avg_marks.toFixed(1),"bi-award")].forEach((t,n)=>{t.classList.add("animate-in","stagger-"+(n%5+1)),e.appendChild(t)});const n=document.getElementById("dashboard-activity-root");n&&Array.isArray(t.upcoming_assignments)&&f(n,t.upcoming_assignments)},g=(e,t)=>{[h("Total Classes",t.classes,"bi-grid"),h("Total Students",t.students,"bi-people"),h("Pending Grading",t.assignments,"bi-clipboard-check")].forEach((t,n)=>{t.classList.add("animate-in","stagger-"+(n%5+1)),e.appendChild(t)});const n=document.getElementById("dashboard-activity-root");n&&t.academic?.upcoming_assignments&&f(n,t.academic.upcoming_assignments)},b=(e,t)=>{[h("Total Students",t.general?.students||0,"bi-people"),h("Active Teachers",t.general?.teachers||0,"bi-person-badge"),h("Total Classes",t.general?.classes||0,"bi-building"),h("Assignments",t.general?.assignments||0,"bi-journal-text"),h("Paid Invoices",t.finance?.invoices?.paid||0,"bi-check-all"),h("Overdue Invoices",t.finance?.invoices?.overdue||0,"bi-exclamation-triangle-fill"),h("Total Revenue",M(t.finance?.payments?.total_amount||0),"bi-cash-stack"),h("Month Revenue",M(t.finance?.payments?.this_month_amount||0),"bi-wallet2"),h("Outstanding Balance",M(t.finance?.outstanding_balance||0),"bi-piggy-bank")].forEach((t,n)=>{t.classList.add("animate-in","stagger-"+(n%5+1)),e.appendChild(t)});const n=document.getElementById("dashboard-activity-root");n&&Array.isArray(t.academic?.upcoming_assignments)&&f(n,t.academic.upcoming_assignments)},h=(e,t,n="bi-graph-up")=>{const a=document.createElement("div");a.className="col-md-4";const s=document.createElement("div");s.className="card-premium h-100 d-flex align-items-center gap-3 p-4";const o=document.createElement("div");o.className="avatar-md bg-primary-subtle rounded-circle text-primary d-flex align-items-center justify-content-center shadow-sm",o.style.minWidth="54px",o.style.height="54px",o.innerHTML=`<i class="bi ${n} fs-3"></i>`;const i=document.createElement("div");i.className="flex-fill";const d=document.createElement("p");d.className="text-muted text-uppercase fw-semibold small mb-1",d.style.letterSpacing="0.5px",d.textContent=e;const r=document.createElement("h2");return r.className="h2 mb-0 fw-bold text-dark",r.textContent=t,i.append(d,r),s.append(o,i),a.appendChild(s),a},f=(e,t)=>{e.replaceChildren();const n=document.createElement("div");n.className="card-premium p-3";const a=document.createElement("h5");a.textContent="Upcoming Deadlines",a.className="mb-3 fw-bold";const s=document.createElement("div");s.className="vstack gap-3",0===t.length&&(s.innerHTML='<div class="text-center py-3 text-muted">No upcoming assignments</div>'),t.forEach((e,t)=>{const n=document.createElement("div");n.className="d-flex align-items-center gap-3 p-3 rounded-4 border bg-white shadow-sm hover-lift animate-in",n.classList.add("stagger-"+(t%5+1));const a=document.createElement("div");a.className="avatar-sm bg-primary-subtle rounded-circle text-primary d-flex align-items-center justify-content-center",a.style.minWidth="42px",a.style.height="42px",a.innerHTML='<i class="bi bi-journal-text fs-5"></i>';const o=document.createElement("div");o.className="flex-fill";const i=document.createElement("div");i.className="fw-bold text-dark",i.textContent=e.title;const d=document.createElement("div");d.className="small text-muted",d.textContent=e.due_date?new Date(e.due_date).toLocaleDateString():"N/A",o.append(i,d),n.append(a,o),s.appendChild(n)}),n.append(a,s),e.appendChild(n)},x=async(e,t,a)=>{const s=document.getElementById(t);if(!s)return;n.controllers.table&&n.controllers.table.abort(),n.controllers.table=new AbortController;const{signal:o}=n.controllers.table;s.replaceChildren();const d=document.createElement("tr");d.className="shimmer-row",d.innerHTML='<td colspan="10" class="text-center py-5">\n            <div class="spinner-border text-primary-premium spinner-border-sm" role="status"></div>\n            <span class="ms-2 text-muted">Synchronizing data...</span>\n        </td>',s.appendChild(d);try{if(await i(),o.aborted)return;const d=n.currentStudentId;let c=e;n.table.lastUrl=e,n.table.tbodyId=t,n.table.entityType=a;const l=c.includes("?")?"&":"?";if(d&&(c+=`${l}student_id=${d}`),n.table.sortField){const e=c.includes("?")?"&":"?";c+=`${e}sort_by=${n.table.sortField}&sort_order=${n.table.sortOrder}`}const m=await axios.get(c,{signal:o}),u=m?.data?.data;if(o.aborted)return;if(s.replaceChildren(),!Array.isArray(u)||0===u.length)return void s.appendChild(_("No records found"));const p=s.closest("table").querySelectorAll("thead th"),g=Array.from(p).map(e=>e.innerText.trim()),b=document.createDocumentFragment(),h="function"==typeof a;u.forEach((e,t)=>{let n;if(h){const t=a(e),s=document.createElement("template");s.innerHTML=t.trim(),n=s.content.firstChild}else n=w(e,a,g);n&&(n.classList.add("animate-in"),n.classList.add("stagger-"+(t%5+1)),b.appendChild(n))}),s.appendChild(b),s.appendChild(b),v(t),r(),m.data=null}catch(e){if(axios.isCancel(e)||"AbortError"===e.name)return;console.error("Table render error:",e),s.replaceChildren();let t="Error loading data";403===e.response?.status?t='<i class="bi bi-shield-lock me-1"></i> Access Denied':404===e.response?.status&&(t='<i class="bi bi-exclamation-circle me-1"></i> Resource Not Found'),s.appendChild(_(t,!0))}finally{n.controllers.table?.signal===o&&(n.controllers.table=null)}},y=e=>{const t=e.target.closest("th.sortable-header");if(!t)return;const a=t.dataset.sort;a&&(n.table.sortField===a?n.table.sortOrder="asc"===n.table.sortOrder?"desc":"asc":(n.table.sortField=a,n.table.sortOrder="asc"),n.table.lastUrl&&x(n.table.lastUrl,n.table.tbodyId,n.table.entityType))},v=e=>{const t=document.getElementById(e)?.closest("table");t&&t.querySelectorAll("th.sortable-header").forEach(e=>{e.classList.remove("sort-asc","sort-desc"),e.dataset.sort===n.table.sortField&&e.classList.add(`sort-${n.table.sortOrder}`)})},w=(e,t,i=[])=>{const d=document.createElement("tr"),r=n.user||window.AppConfig?.user,c=(r?.roles||[]).map(e=>String(e).toLowerCase().replace(/\s+/g,"_")),l=c.includes("super_admin")||c.includes("admin")||c.includes("owner");const m=(e,t)=>{i[t]&&(e.dataset.label=i[t]),d.appendChild(e)};if("assignment"===t){const n=document.createElement("td");n.textContent=e.title,d.appendChild(n);const a=document.createElement("td");a.textContent=e.class_room?.name||"N/A",d.appendChild(a);const s=document.createElement("td");s.textContent=e.subject?.name||"N/A",d.appendChild(s);const o=document.createElement("td");o.textContent=new Date(e.due_date).toLocaleDateString(),d.appendChild(o);const r=document.createElement("td"),u="active"===e.status;r.innerHTML=`<span class="badge bg-${u?"success":"secondary"}-subtle text-${u?"success":"secondary"} px-2">${e.status}</span>`,d.appendChild(r);const p=document.createElement("td");if(p.className="text-end",c.includes("student")){const n=document.createElement("button");n.className="btn btn-sm btn-primary-premium ms-1",n.innerHTML='<i class="bi bi-send"></i> Submit',n.onclick=()=>openSubmissionModal(e),p.appendChild(n),(l||c.includes("teacher")||c.includes("school_admin"))&&p.append(C('<i class="bi bi-pencil-square"></i>',"edit",t,e.id),C('<i class="bi bi-trash"></i>',"delete",t,e.id))}else E(t,"edit",c,l)&&p.appendChild(C('<i class="bi bi-pencil-square"></i>',"edit",t,e.id)),E(t,"delete",c,l)&&p.appendChild(C('<i class="bi bi-trash"></i>',"delete",t,e.id));return m(p,i.length-1),d}if("student"===t){const t=document.createElement("td");t.innerHTML=`\n                <div class="d-flex align-items-center">\n                    <div class="avatar-sm me-2 bg-light rounded text-center" style="width:32px; height:32px; line-height:32px;">\n                        <i class="bi bi-person text-primary"></i>\n                    </div>\n                    <div>\n                        <div class="fw-bold text-dark">${a(e.full_name||e.name)}</div>\n                        <div class="small text-muted">${a(e.user?.email||e.email||"")}</div>\n                    </div>\n                </div>\n            `,m(t,0);const n=document.createElement("td");n.innerHTML=`<span class="badge bg-light text-dark border">${a(e.admission_number)}</span>`,m(n,1);const s=document.createElement("td");s.textContent=e.current_class||e.class_room?.name||"N/A",m(s,2);const o=document.createElement("td");o.innerHTML=`<span class="text-capitalize">${a(e.gender||e.user?.gender||"N/A")}</span>`,m(o,3);const i=document.createElement("td"),d=!0===e.status||1===e.status||"active"===e.status;i.innerHTML=`<span class="badge bg-${d?"success":"secondary"}-subtle text-${d?"success":"secondary"} px-2">\n                ${d?"Active":"Inactive"}\n            </span>`,m(i,4)}else if("school"===t){const t=document.createElement("td");t.innerHTML=s`
                <div class="fw-bold text-dark">${e.name}</div>
                <div class="small text-muted">${e.email||""}</div>
                <div class="small text-muted">${e.phone||""}</div>
            `,m(t,0);const n=document.createElement("td");n.innerHTML=s`
                <div class="small text-wrap" style="max-width: 200px;">${e.address||""}</div>
                <div class="small text-muted">${e.city||""}, ${e.state||""}</div>
            `,m(n,1);const a=document.createElement("td");a.innerHTML=s`
                <div>${e.contact_person||"N/A"}</div>
                <div class="small text-muted">${e.contact_person_phone||""}</div>
            `,m(a,2);const o=document.createElement("td");o.innerHTML=`\n                <span class="badge bg-light text-dark border me-1"><i class="bi bi-people"></i> ${e.users_count||0}</span>\n                <span class="badge bg-light text-dark border"><i class="bi bi-mortarboard"></i> ${e.students_count||0}</span>\n            `,m(o,3);const i=document.createElement("td");i.innerHTML=`<span class="badge bg-info-subtle text-info text-uppercase">${e.plan||"Basic"}</span>`,m(i,4);const d=document.createElement("td"),r=e.is_active||"active"===e.status;d.innerHTML=`<span class="badge bg-${r?"success":"danger"}-subtle text-${r?"success":"danger"} px-2">\n                ${e.status_label||(r?"Active":"Inactive")}\n            </span>`,m(d,5)}else if("teacher"===t){const t=e.user?.profile_photo_url||"",n=document.createElement("td");n.innerHTML=s`
                <div class="d-flex align-items-center">
                    <div class="avatar-sm me-3">
                ${o(t?s`<img src="${t}" class="rounded-circle" style="width:38px; height:38px; object-fit:cover;" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(e.user?.name||"T")}&color=7F9CF5&background=EBF4FF'">`:s`<div class="avatar-sm bg-primary-subtle rounded-circle text-primary d-flex align-items-center justify-content-center" style="width:38px; height:38px;">
                                <i class="bi bi-person-workspace"></i>
                            </div>`)}
                    </div>
                    <div>
                        <div class="fw-bold text-dark">${e.user?.name||e.name||"N/A"}</div>
                        <div class="small text-muted text-lowercase">${e.user?.email||e.email||""}</div>
                    </div>
                </div>
            `,m(n,0);const i=document.createElement("td");i.innerHTML=`<span class="badge bg-light text-dark border">${a(e.employee_number||"N/A")}</span>`,m(i,1);const d=document.createElement("td"),r=null===e.deleted_at&&("active"===e.status||!0===e.status||1===e.status||void 0===e.status||null===e.status);d.innerHTML=`<span class="badge bg-${r?"success":"secondary"}-subtle text-${r?"success":"secondary"} px-2">\n                ${r?"Active":"Inactive"}\n            </span>`,m(d,2);const c=document.createElement("td");c.className="text-muted small",c.textContent=e.user?.phone||"N/A",m(c,3);const l=document.createElement("td");l.className="text-muted small",l.textContent=e.hire_date?new Date(e.hire_date).toLocaleDateString():"N/A",m(l,4)}else{if("attendance"===t){const t=document.createElement("td");t.textContent=e.student?.user?.name||e.student?.full_name||"N/A",m(t,0);const n=document.createElement("td");n.className="text-center",n.innerHTML=`<input type="radio" name="attendance[${e.id}][status]" value="present" ${"present"===e.status?"checked":""}>`,m(n,1);const a=document.createElement("td");a.className="text-center",a.innerHTML=`<input type="radio" name="attendance[${e.id}][status]" value="late" ${"late"===e.status?"checked":""}>`,m(a,2);const s=document.createElement("td");s.className="text-center",s.innerHTML=`<input type="radio" name="attendance[${e.id}][status]" value="absent" ${"absent"===e.status?"checked":""}>`,m(s,3);const o=document.createElement("td");return o.innerHTML=`<input type="text" name="attendance[${e.id}][remark]" class="form-control form-control-sm" value="${e.remark||""}">`,m(o,4),d}if("payment"===t||"fee-payment"===t){const t=document.createElement("td");t.textContent=e.student?.user?.name||e.student?.full_name||"N/A",m(t,0);const n=document.createElement("td");n.textContent=e.amount||"0",m(n,1);const a=document.createElement("td");a.textContent=e.payment_date?new Date(e.payment_date).toLocaleDateString():"N/A",m(a,2);const s=document.createElement("td");s.textContent=e.payment_method||"N/A",m(s,3);const o=document.createElement("td");o.innerHTML=`<span class="badge bg-${"paid"===e.status?"success":"warning"}-subtle text-${"paid"===e.status?"success":"warning"} px-2">${e.status}</span>`,m(o,4)}else if("class"===t||"subject"===t||"session"===t||"section"===t||"feeType"===t||"fee-type"===t){const n=document.createElement("td");if(n.innerHTML=`<strong>${e.name||e.title||"N/A"}</strong>`,m(n,0),"class"===t){const t=document.createElement("td");t.textContent=e.class_teacher?.user?.name||"N/A",m(t,1);const n=document.createElement("td");n.innerHTML=`<span class="badge bg-primary-subtle text-primary border">${e.students_count||0}</span>`,m(n,2);const a=document.createElement("td");a.innerHTML=`<span class="badge bg-info-subtle text-info border">${e.subjects_count||0}</span>`,m(a,3);const s=document.createElement("td");s.innerHTML=`<span class="badge bg-warning-subtle text-warning border">${e.assignments_count||0}</span>`,m(s,4)}else if("feeType"===t||"fee-type"===t){const t=document.createElement("td");t.textContent=e.amount||"0",m(t,1)}}else if("lessonNote"===t){const t=document.createElement("td");t.innerHTML=`<strong>${a(e.title)}</strong>`,m(t,0);const n=document.createElement("td");n.textContent=e.class_room?.name||"N/A",m(n,1);const s=document.createElement("td");s.textContent=e.subject?.name||"N/A",m(s,2);const o=document.createElement("td");o.textContent=e.date?new Date(e.date).toLocaleDateString():"N/A",m(o,3)}else if("guardian"===t){const t=document.createElement("td");t.innerHTML=`\n                <div class="d-flex align-items-center">\n                    <div class="avatar-sm me-2 bg-light rounded text-center" style="width:32px; height:32px; line-height:32px;">\n                        <i class="bi bi-person-check text-primary"></i>\n                    </div>\n                    <div>\n                        <div class="fw-bold text-dark">${a(e.user?.name||e.name||"N/A")}</div>\n                        <div class="small text-muted">${a(e.user?.email||e.email||"")}</div>\n                    </div>\n                </div>\n            `,m(t,0);const n=document.createElement("td");n.innerHTML=`\n                <div>${a(e.user?.phone||"N/A")}</div>\n                <div class="small text-muted">${a(e.occupation||"")}</div>\n            `,m(n,1);const s=document.createElement("td");s.innerHTML=`<span class="badge bg-info-subtle text-info text-capitalize px-2">${a(e.relation||"N/A")}</span>`,m(s,2)}else{const t=document.createElement("td");t.textContent=e.name||e.title||"N/A",m(t,0)}}const u=document.createElement("td");if(u.className="text-end","school"===t&&!e.is_active&&l){const t=document.createElement("button");t.type="button",t.className="btn btn-sm btn-success-subtle text-success me-1",t.innerHTML='<i class="bi bi-check-lg"></i>',t.title="Approve School",t.onclick=()=>window.approveSchool?window.approveSchool(e.id):console.warn("approveSchool fn missing"),u.appendChild(t)}return E(t,"edit",c,l)&&u.appendChild(C('<i class="bi bi-pencil-square"></i>',"edit",t,e.id)),E(t,"delete",c,l)&&u.appendChild(C('<i class="bi bi-trash"></i>',"delete",t,e.id)),m(u,i.length-1),d},E=(e,t,n,a)=>{if(a)return!0;const s={student:{edit:["school_admin"],delete:["school_admin"]},teacher:{edit:["school_admin"],delete:["school_admin"]},guardian:{edit:["school_admin","teacher"],delete:["school_admin"]},class:{edit:["school_admin"],delete:["school_admin"]},subject:{edit:["school_admin"],delete:["school_admin"]},session:{edit:["school_admin"],delete:["school_admin"]},term:{edit:["school_admin"],delete:["school_admin"]},section:{edit:["school_admin"],delete:["school_admin"]},enrollment:{edit:["school_admin"],delete:["school_admin"]},assignment:{edit:["school_admin","teacher"],delete:["school_admin","teacher"]},lessonNote:{edit:["school_admin","teacher"],delete:["school_admin","teacher"]},assessment:{edit:["school_admin","teacher"],delete:["school_admin","teacher"]},result:{edit:["school_admin","teacher"],delete:["school_admin","teacher"]},payment:{edit:["school_admin"],delete:["school_admin"]},feeType:{edit:["school_admin"],delete:["school_admin"]},school:{edit:["super_admin"],delete:["super_admin"]}}[e]?.[t];return!!s&&n.some(e=>s.includes(e))},C=(e,t,n,a)=>{const s=document.createElement("button");return s.type="button",s.className=`btn btn-sm btn-outline-${"delete"===t?"danger":"primary"} ms-1`,s.innerHTML=e,s.dataset.action=t,s.dataset.entity=n,s.dataset.id=a,s},_=(e,t=!1)=>{const n=document.createElement("tr"),a=document.createElement("td");return a.colSpan=10,a.className="text-center py-4 "+(t?"text-danger":"text-muted"),a.innerHTML=e,n.appendChild(a),n},S=async e=>{const t=e.target.closest("button[data-action]");if(!t)return;const{action:n,entity:a,id:s}=t.dataset,o=$(a);if("delete"===n){const e=window[`reload${H(a)}s`]||window[`reload${H(a)}`];N(`/api/v1/${o}/${s}`,e)}if("edit"===n){const e=t.innerHTML;t.disabled=!0,t.innerHTML='<span class="spinner-border spinner-border-sm"></span>';try{const e=await axios.get(`/api/v1/${o}/${s}`),t=e?.data?.data||e?.data,n=window[`edit${H(a)}`];"function"==typeof n?n(t):console.error(`Global function edit${H(a)} not found.`),e.data=null}catch(e){console.error(`Failed to fetch ${a} data:`,e),Swal.fire({icon:"error",title:"Error",text:"Failed to load item data."})}finally{t.disabled=!1,t.innerHTML=e}}},$=e=>{const t={class:"classes",library:"library/books",session:"school-sessions",feeType:"fee-types",invoiceItem:"invoice-items",lessonNote:"lesson-notes",assignmentSubmission:"assignment-submissions","fee-type":"fee-types"};return t[e]?t[e]:`${e}s`},A=e=>{e.querySelectorAll(".is-invalid").forEach(e=>e.classList.remove("is-invalid")),e.querySelectorAll(".invalid-feedback").forEach(e=>e.remove())},L=(e,t)=>{Object.entries(t).forEach(([t,n])=>{const a=e.elements[t];if(!a)return;a.classList.add("is-invalid");const s=document.createElement("div");s.className="invalid-feedback",s.textContent=n[0],a.after(s)})},T=(e,t,n="")=>{t&&Object.entries(t).forEach(([t,a])=>{const s=n?`${n}[${t}]`:t;if(null===a||"object"!=typeof a||Array.isArray(a)){const n=e.elements[s]||e.elements[t];if(n)if("checkbox"===n.type)n.checked=!!a;else if("radio"===n.type){const t=e.querySelector(`input[name="${s}"][value="${a}"]`);t&&(t.checked=!0)}else n.value=a??""}else T(e,a,s),T(e,a,"")})},N=async(e,t=null)=>{if((await Swal.fire({title:"Are you sure?",text:"You won't be able to revert this!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Yes, delete it!"})).isConfirmed)try{await axios.delete(e),await Swal.fire({title:"Deleted!",text:"Your item has been deleted.",icon:"success",timer:1500,showConfirmButton:!1}),t&&"function"==typeof t?t():location.reload()}catch(e){Swal.fire({icon:"error",title:"Oops...",text:"Failed to delete item"})}},k=e=>{if(!e)return;const t=document.getElementById(e);t&&bootstrap.Modal.getInstance(t)?.hide()},M=e=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(e||0),H=e=>e.charAt(0).toUpperCase()+e.slice(1),I={init:async()=>{t||(document.addEventListener("click",S),document.addEventListener("click",y),t=!0);await i();document.getElementById("dashboard-stats-root")&&c(),d(),r()},renderTable:x,submitForm:async(e,t,n,a)=>{e.preventDefault();const s=e.target,o=s.querySelector('button[type="submit"]'),i=o?.innerHTML,d=new FormData(s);A(s),o&&(o.disabled=!0,o.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Saving...');try{const e=await axios({method:s.method,url:s.action,data:d});k(a),s.reset(),Swal.fire({icon:"success",title:"Success!",text:e.data.message||"Action completed successfully",timer:2e3,showConfirmButton:!1}),t?t(e.data):location.reload()}catch(e){422===e.response?.status?L(s,e.response.data.errors):Swal.fire({icon:"error",title:"Oops...",text:e.response?.data?.message||"Something went wrong!"})}finally{o&&(o.disabled=!1,o.innerHTML=i)}},populateForm:T,deleteItem:N,logout:async()=>{console.log("App: Logout initiated");try{await axios.post("/logout"),Swal.fire({icon:"success",title:"Logged Out",text:"You have been successfully logged out.",timer:1e3,showConfirmButton:!1,position:"top-end",toast:!0})}catch(e){console.warn("App: Logout API failed or was unauthorized",e)}finally{console.log("App: Cleaning up storage and redirecting"),localStorage.clear(),sessionStorage.clear(),setTimeout(()=>{window.location.replace("/")},800)}},loadOptions:async(e,t,n=null,a="id",s="name",o="Select option")=>{const i=document.getElementById(t);if(!i)return;i.replaceChildren();const d=document.createElement("option");d.textContent="Loading options...",i.appendChild(d),i.disabled=!0;try{const t=await axios.get(e),d=t?.data?.data||t?.data||[];i.replaceChildren();const r=document.createElement("option");r.value="",r.textContent=o,i.appendChild(r),d.forEach(e=>{const t=document.createElement("option");t.value=e[a],t.textContent="function"==typeof s?s(e):e[s]||"N/A",n&&String(e[a])===String(n)&&(t.selected=!0),i.appendChild(t)}),i.disabled=!1}catch(e){console.error("loadOptions error:",e),i.replaceChildren();const t=document.createElement("option");t.textContent="Failed to load",i.appendChild(t)}},renderStudentSelector:d,selectStudent:e=>{localStorage.setItem("guardian_selected_student_id",e),n.currentStudentId=e,location.reload()},resetForm:e=>{e&&(e.reset(),A(e))},safeHTML:s,trust:o,escapeText:a,get user(){return n.user},set user(e){n.user=e},get currentStudentId(){return n.currentStudentId},set currentStudentId(e){n.currentStudentId=e},renderPlatformStats:u,enforceSessionLock:r,loadGradingOptions:async(e,t=null)=>{const n=document.getElementById(e);if(n)try{const e=await axios.get("/api/v1/settings/grading-scale"),a=e.data?.data||[];n.replaceChildren();const s=document.createElement("option");s.value="",s.textContent="Select Grade",n.appendChild(s),a.forEach(e=>{const a=document.createElement("option");a.value=e.grade,a.textContent=`${e.grade} (${e.min}-${e.max})`,t&&String(t)===String(e.grade)&&(a.selected=!0),n.appendChild(a)})}catch(e){console.error("Failed to load grading scale",e),n.innerHTML='<option value="">Error loading grades</option>'}}};return window.App=I,I})();document.addEventListener("DOMContentLoaded",async()=>{try{const e=new SidebarManager;await e.init(),window.App&&"function"==typeof window.App.init&&window.App.init()}catch(e){console.error("App: Critical initialization failure",e)}});